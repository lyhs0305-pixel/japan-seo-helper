async function generateAIContent() {
  const btn = document.getElementById('generateBtn');
  const workerUrl = "https://travel-content-generator.lyhs0305.workers.dev/";
  
  const sourceInfo = document.getElementById('sourceInfo').value;
  const market = document.getElementById('marketSelect').value;
  const planCards = document.querySelectorAll('.input-card');
  
  if (!sourceInfo) { alert("請輸入商品情報"); return; }

  btn.innerText = "AI 正在撰寫中 (約需 5-10 秒)...";
  btn.disabled = true;

  let plansPrompt = "";
  planCards.forEach((card, i) => {
    plansPrompt += `方案${i+1}: 名稱為 ${card.querySelector('.plan-name').value}, 內容為 ${card.querySelector('.plan-desc').value}\n`;
  });

  const finalPrompt = `你是一位專業旅遊文案專家。請根據以下資料生成結構化文案：
  客群：${market}
  商品原始資料：${sourceInfo}
  ${plansPrompt}
  
  請務必以 JSON 格式輸出，不要包含任何 Markdown 標籤（如 \`\`\`json），結構如下：
  {
    "title_zh": "標題", "title_ja": "日文標題",
    "summary_zh": "SEO簡述", "summary_ja": "日文SEO",
    "desc_zh": "完整說明", "desc_ja": "日文完整說明",
    "plans": [{"name_zh": "名稱", "name_ja": "日文名", "desc_zh": "描述", "desc_ja": "日文描述"}]
  }`;

  try {
    const response = await fetch(workerUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: finalPrompt })
    });

    if (!response.ok) throw new Error(`HTTP 錯誤: ${response.status}`);

    const result = await response.json();
    
    // 檢查 Gemini 是否有正確回傳內容
    if (!result.candidates || !result.candidates[0].content.parts[0].text) {
      throw new Error("AI 未能產出有效內容");
    }

    let rawText = result.candidates[0].content.parts[0].text;
    
    // 清理可能存在的 Markdown 標籤
    rawText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
    
    const aiData = JSON.parse(rawText);

    // 渲染資料
    document.getElementById('res-title-zh').innerText = aiData.title_zh;
    document.getElementById('res-title-ja').innerText = aiData.title_ja;
    document.getElementById('res-summary-zh').innerText = aiData.summary_zh;
    document.getElementById('res-summary-ja').innerText = aiData.summary_ja;
    document.getElementById('res-desc-zh').innerText = aiData.desc_zh;
    document.getElementById('res-desc-ja').innerText = aiData.desc_ja;

    const container = document.getElementById('planPreviewContainer');
    container.innerHTML = '';
    aiData.plans.forEach((p, i) => {
      container.innerHTML += `
        <div>
          <div class="flex items-center gap-3 mb-3">
            <span class="text-[10px] font-bold bg-[#6A8D92] text-white px-2 py-0.5 rounded-sm uppercase font-sans">PLAN ${i+1}</span>
            <div>
              <p class="text-[14px] font-bold text-gray-800">${p.name_zh}</p>
              <p class="text-[11px] text-gray-400 font-light italic">${p.name_ja}</p>
            </div>
          </div>
          <div class="pl-11 space-y-2">
            <p class="text-[13px] text-gray-600 leading-relaxed">${p.desc_zh}</p>
            <p class="text-[11px] text-gray-400 font-light italic leading-relaxed">${p.desc_ja}</p>
          </div>
        </div>`;
    });
    
    // 成功後將視窗滾動到預覽區域
    document.querySelector('.sticky-preview').scrollTo({ top: 0, behavior: 'smooth' });

  } catch (e) {
    console.error("詳細錯誤:", e);
    alert("生成出錯: " + e.message + "\n請檢查 Console 獲取詳細資訊。");
  } finally {
    btn.innerText = "生成 AI 優化內容";
    btn.disabled = false;
  }
}
